-- object, model, x,y,z, rx,ry,rz, i, d
local CasinoGame = {
	["The Four Dragons"] = {
		["SLOT1"] = {
			[2] = {false, 2327, 1965.11, 998.32, 992.99, 0,0,80, 10, 0},
		},
		["SLOT2"] = {
			[2] = {false, 2347, 1962.42, 991.89, 992.99, 0,0,54, 10, 0},
		},
		["SLOT3"] = {
			[2] = {false, 2327, 1957.75, 987.20, 992.99, 0,0,32, 10, 0},
		},
		["SLOT4"] = {
			[2] = {false, 2347, 1964.56, 998.43, 992.99, 0,0,259, 10, 0}, 
		},
		["SLOT5"] = {
			[2] = {false, 2327, 1961.95, 992.18, 992.99, 0,0,235, 10, 0},
		},
		["SLOT6"] = {
			[2] = {false, 2347, 1957.43, 987.65, 992.99, 0,0,213, 10, 0}, 
		}, 
		["SLOT7"] = {
			[2] = {false, 2327, 1965.10, 1037.37, 992.99, 0,0,101, 10, 0},
		},
		["SLOT8"] = {
			[2] = {false, 2327, 1962.40, 1043.65, 992.99, 0,0,123, 10, 0},
		},
		["SLOT9"] = {
			[2] = {false, 2347, 1957.64, 1048.44, 992.99, 0,0,145, 10, 0},
		},
		["SLOT10"] = {
			[2] = {false, 2327, 1964.55, 1037.26, 992.99, 0,0,281, 10, 0},
		},
		["SLOT11"] = {
			[2] = {false, 2347, 1961.96, 1043.36, 992.99, 0,0,303, 10, 0},
		},
		["SLOT12"] = {
			[2] = {false, 2327, 1957.34, 1047.97, 992.99, 0,0,325, 10, 0},
		},
		-- 1956.9, 1047.3, 992.5
	}, 
	["Caligula's Palace"] = {
		["SLOT1"] =  {
			[2] = {false, 2347, 2255.17, 1617.55, 1006.78, 0,0,0, 1, 0},
		},
		["SLOT2"] =  {
			[2] = {false, 2327, 2255.17, 1618.05, 1006.78, 0,0,180, 1, 0},
		},
		["SLOT3"] =  {
			[2] = {false, 2347, 2255.17, 1614.18, 1006.78, 0,0,180, 1, 0},
		},
		["SLOT4"] =  {
			[2] = {false, 2327, 2255.17, 1613.65, 1006.78, 0,0,0, 1, 0},
		},
		["SLOT5"] =  {
			[2] = {false, 2347, 2255.17, 1610.12, 1006.78, 0,0,180, 1, 0},
		},
		["SLOT6"] =  {
			[2] = {false, 2327, 2255.17, 1609.60, 1006.78, 0,0,0, 1, 0},
		},
		["SLOT7"] =  {
			[2] = {false, 2347, 2218.65, 1619.08, 1006.78, 0,0,180, 1, 0},
		},
		["SLOT8"] =  {
			[2] = {false, 2327, 2218.65, 1618.55, 1006.78, 0,0,0, 1, 0},
		},
		["SLOT9"] =  {
			[2] = {false, 2347, 2218.65, 1614.75, 1006.78, 0,0,180, 1, 0},
		},
		["SLOT10"] =  {
			[2] = {false, 2327, 2218.65, 1614.22, 1006.78, 0,0,0, 1, 0},
		},
		["SLOT11"] =  {
			[2] = {false, 2347, 2218.65, 1592.92, 1006.78, 0,0,180, 1, 0},
		},
		["SLOT12"] =  {
			[2] = {false, 2327, 2218.65, 1592.39, 1006.78, 0,0,0, 1, 0},
		},
		["SLOT13"] =  {
			[2] = {false, 2347, 2218.65, 1588.61, 1006.78, 0,0,180, 1, 0},
		},
		["SLOT14"] =  {
			[2] = {false, 2327, 2218.65, 1588.07, 1006.78, 0,0,0, 1, 0},
		},
		["SLOT15"] =  {
			[2] = {false, 2347, 2269.25, 1606.665, 1006.78, 0,0,270, 1, 0},
		},
		["SLOT16"] =  {
			[2] = {false, 2327, 2269.78, 1606.665, 1006.78, 0,0,90, 1, 0},
		},
		["SLOT17"] =  {
			[2] = {false, 2347, 2273.30, 1606.665, 1006.78, 0,0,270, 1, 0},
		},
		["SLOT18"] =  {
			[2] = {false, 2327, 2273.83, 1606.665, 1006.78, 0,0,90, 1, 0},
		},
		["SLOT19"] =  {
			[2] = {false, 2347, 2220.67, 1603.915, 1006.78, 0,0,270, 1, 0},
		},
		["SLOT20"] =  {
			[2] = {false, 2327, 2221.21, 1603.915, 1006.78, 0,0,90, 1, 0},
		},
		["SLOT21"] =  {
			[2] = {false, 2347, 2217.02, 1603.915, 1006.78, 0,0,270, 1, 0},
		},
		["SLOT22"] =  {
			[2] = {false, 2327, 2217.55, 1603.915, 1006.78, 0,0,90, 1, 0},
		},
		--2221.9, 1603.9, 1006.2
	}
}






local CasinoObjectInfo = {
	[2327] = {
		[0] = "Cherry",
		[18] = "Bar",
		[36] = "Cherry",
		[54] = "Blueberry",
		[72] = "Seven",
		[90] = "Melon",
		[108] = "Seven",
		[126] = "Blueberry",
		[144] = "Bell",
		[162] = "Melon",
		[180] = "Cherry",
		[198] = "Double Bar",
		[216] = "Cherry",
		[234] = "Tripple Bar",
		[252] = "Seven",
		[270] = "Blueberry",
		[288] = "Bar",
		[306] = "Seven",
		[324] = "Melon",
		[342] = "Bell"
	},
	[2347] = {
		[0] = "Double Gold",
		[20] = "69",
		[40] = "Gold",
		[60] = "Bell",
		[80] = "Cherry",
		[100] = "Blueberry",
		[120] = "Cherry",
		[140] = "Blueberry",
		[160] = "Bell",
		[180] = "69",
		[200] = "Bell",
		[220] = "Gold",
		[240] = "Cherry",
		[260] = "Blueberry",
		[280] = "69",
		[300] = "Blueberry",
		[320] = "Bell",
		[340] = "Cherry",
	}
}

local CasinoPrice = {
	["Blueberry"] = 2,
	["Cherry"] = 4,
	["Bar"] = 7,
	["Gold"] = 7,
	["Bell"] = 10,
	["Double Bar"] = 15,
	["Double Gold"] = 15,
	["69"] = 20,
	["Tripple Bar"] = 25,
	["Melon"] = 30,
	["Seven"] = 30
}



function RotateBandits(obj, times) -- Возвращает значение
	local MaxCombo = 360/getArrSize(CasinoObjectInfo[getElementModel(obj)])
	local rx,ry,rz = getElementRotation(obj)
	rx = math.round(rx)
	local out = rx+(times*MaxCombo)
	if(out >= 360) then
		out = out-(360*math.floor(out/360))
	end

	setTimer(function(obj)
		local x,y,z = getElementPosition(obj)
		local rx,ry,rz = getElementRotation(obj)
		rx = math.round(rx)
		setElementRotation(obj,rx+MaxCombo,ry,rz, "default")
	end, 50, times, obj)
	return CasinoObjectInfo[getElementModel(obj)][out]
end



function PlayCasino(thePlayer, dat)
	dat = fromJSON(dat)
	local casino, game = dat[1], dat[2]
	if(not isTimer(CasinoGame[casino][game]["timer"])) then
		if(triggerEvent("AddPlayerMoney", thePlayer, thePlayer, -100)) then
			local MaxCombo = 360/getArrSize(CasinoObjectInfo[CasinoGame[casino][game][2][2]])
			local r1,r2,r3 = math.random(1,MaxCombo), math.random(MaxCombo,MaxCombo*2), math.random(MaxCombo*2,MaxCombo*3)
			victory = false
			local ro1, ro2, ro3 = RotateBandits(CasinoGame[casino][game][1][1], r1), RotateBandits(CasinoGame[casino][game][2][1], r2), RotateBandits(CasinoGame[casino][game][3][1], r3)
			if(ro1 == ro2) then
				victory = CasinoPrice[ro1]*CasinoPrice[ro2]
				if(ro2 == ro3) then
					victory = CasinoPrice[ro1]*CasinoPrice[ro2]*CasinoPrice[ro3]
				end
			end
			CasinoGame[casino][game]["timer"] = setTimer(function(thePlayer, victory)
				if(victory) then
					triggerEvent("AddPlayerMoney", thePlayer, thePlayer, victory, "ВЫИГРЫШ")
				end
			end, 1000+(50*r3), 1, thePlayer, victory)
		end
	end
end
addEvent("PlayCasino", true)
addEventHandler("PlayCasino", root, PlayCasino)



function table.copy(t)
	local t2 = {};
	for k,v in pairs(t) do
		if type(v) == "table" then
			t2[k] = table.copy(v);
		else
			t2[k] = v;
		end
	end
	return t2;
end




function math.round(number, decimals, method)
    decimals = decimals or 0
    local factor = 10 ^ decimals
    if (method == "ceil" or method == "floor") then return math[method](number * factor) / factor
    else return tonumber(("%."..decimals.."f"):format(number)) end
end

function getArrSize(arr)
	local i = 0
	for _,_ in pairs(arr) do i=i+1 end
	return i
end


 
function getPointInFrontOfPoint(x, y, z, rZ, dist)
	local offsetRot = math.rad(rZ)
	local vx = x + dist * math.cos(offsetRot)
	local vy = y + dist * math.sin(offsetRot)  
	return vx, vy, z
end

for CasinoName, data in pairs(CasinoGame) do
	for name, obj in pairs(data) do
		local col = createColSphere(obj[2][3], obj[2][4], obj[2][5], 1)
		setElementData(col, "Casino", toJSON({CasinoName, name}))
		
		CasinoGame[CasinoName][name][2][1] = createObject(obj[2][2], obj[2][3], obj[2][4], obj[2][5], obj[2][6], obj[2][7], obj[2][8])
		setElementInterior(CasinoGame[CasinoName][name][2][1], obj[2][9])
		setElementDimension(CasinoGame[CasinoName][name][2][1], obj[2][10])
		
		CasinoGame[CasinoName][name][1] = table.copy(obj[2])
		obj[1][3], obj[1][4], obj[1][5] = getPointInFrontOfPoint(obj[2][3], obj[2][4], obj[2][5], obj[2][8]-180, 0.12)
		CasinoGame[CasinoName][name][1][1] = createObject(obj[1][2], obj[1][3], obj[1][4], obj[1][5], obj[1][6], obj[1][7], obj[1][8])
		setElementInterior(CasinoGame[CasinoName][name][1][1], obj[1][9])
		setElementDimension(CasinoGame[CasinoName][name][1][1], obj[1][10])
		
		CasinoGame[CasinoName][name][3] = table.copy(obj[2])
		obj[3][3], obj[3][4], obj[3][5] = getPointInFrontOfPoint(obj[2][3], obj[2][4], obj[2][5], obj[2][8], 0.12)
		CasinoGame[CasinoName][name][3][1] = createObject(obj[3][2], obj[3][3], obj[3][4], obj[3][5], obj[3][6], obj[3][7], obj[3][8])
		setElementInterior(CasinoGame[CasinoName][name][3][1], obj[3][9])
		setElementDimension(CasinoGame[CasinoName][name][3][1], obj[3][10])
		
	end
end




